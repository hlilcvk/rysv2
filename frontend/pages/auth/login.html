<!DOCTYPE html>
<html lang="tr" data-theme="midnight">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GiriÅŸ â€” RandevuCRM</title>
    <link rel="stylesheet" href="/assets/css/themes.css">
    <link rel="stylesheet" href="/assets/css/base.css">
    <style>
        body { display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .login-card { width: 400px; max-width: 90vw; }
        .login-header { text-align: center; margin-bottom: 28px; }
        .login-header h1 { font-size: 28px; font-weight: 800; margin-bottom: 6px; }
        .login-header p { color: var(--text-tertiary); font-size: 13px; }
        .login-footer { text-align: center; margin-top: 16px; }
        .login-footer a { color: var(--primary); font-size: 12px; }
        .msg { text-align: center; margin-top: 12px; font-size: 13px; padding: 8px; border-radius: 6px; display: none; }
        .msg.err { display: block; background: var(--red-alpha); color: var(--red); }
        .msg.ok { display: block; background: var(--green-alpha); color: var(--green); }
    </style>
</head>
<body>
    <div class="card login-card">
        <div class="login-header">
            <h1>ðŸ—“ RandevuCRM</h1>
            <p>HesabÄ±nÄ±za giriÅŸ yapÄ±n</p>
        </div>

        <div class="form-group">
            <label class="form-label">KullanÄ±cÄ± AdÄ±</label>
            <input type="text" class="form-input" id="username" placeholder="admin" autocomplete="username">
        </div>
        <div class="form-group">
            <label class="form-label">Åžifre</label>
            <input type="password" class="form-input" id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">
        </div>

        <button class="btn btn-primary" style="width:100%;padding:12px;font-size:14px" id="loginBtn" onclick="doLogin()">
            <i class="bi bi-box-arrow-in-right"></i> GiriÅŸ Yap
        </button>

        <div class="msg" id="msg"></div>

        <div class="login-footer">
            <a href="#" onclick="showReset()">Åžifremi unuttum</a>
        </div>

        <!-- Åžifre SÄ±fÄ±rlama (gizli) -->
        <div id="resetSection" style="display:none;margin-top:20px;padding-top:16px;border-top:1px solid var(--border)">
            <p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">KayÄ±tlÄ± telefon numaranÄ±za WhatsApp ile doÄŸrulama kodu gÃ¶ndereceÄŸiz.</p>
            <div class="form-group">
                <label class="form-label">Telefon NumarasÄ±</label>
                <input type="tel" class="form-input" id="resetPhone" placeholder="05XX XXX XXXX">
            </div>
            <button class="btn btn-primary btn-sm" onclick="sendOTP()">Kod GÃ¶nder</button>

            <div id="otpSection" style="display:none;margin-top:12px">
                <div class="form-group">
                    <label class="form-label">DoÄŸrulama Kodu</label>
                    <input type="text" class="form-input" id="otpCode" placeholder="6 haneli kod" maxlength="6">
                </div>
                <div class="form-group">
                    <label class="form-label">Yeni Åžifre</label>
                    <input type="password" class="form-input" id="newPassword" placeholder="En az 6 karakter">
                </div>
                <button class="btn btn-primary btn-sm" onclick="confirmReset()">Åžifreyi DeÄŸiÅŸtir</button>
            </div>
        </div>
    </div>

    <script src="/assets/js/theme.js"></script>
    <script>
        const msgEl = document.getElementById('msg');

        // Enter ile giriÅŸ
        document.getElementById('password').addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });
        document.getElementById('username').addEventListener('keydown', e => { if (e.key === 'Enter') document.getElementById('password').focus(); });

        async function doLogin() {
            const btn = document.getElementById('loginBtn');
            btn.disabled = true;
            msgEl.className = 'msg';

            const body = {
                kullanici_adi: document.getElementById('username').value.trim(),
                sifre: document.getElementById('password').value
            };

            if (!body.kullanici_adi || !body.sifre) {
                msgEl.textContent = 'KullanÄ±cÄ± adÄ± ve ÅŸifre gerekli';
                msgEl.className = 'msg err';
                btn.disabled = false;
                return;
            }

            try {
                const res = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const data = await res.json();

                if (data.success) {
                    localStorage.setItem('auth_token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));

                    msgEl.textContent = 'GiriÅŸ baÅŸarÄ±lÄ±! YÃ¶nlendiriliyorsunuz...';
                    msgEl.className = 'msg ok';

                    setTimeout(() => {
                        if (data.user.is_super_admin) {
                            window.location.href = '/pages/admin/index.html';
                        } else {
                            window.location.href = '/pages/dashboard/index.html';
                        }
                    }, 500);
                } else {
                    msgEl.textContent = data.message || 'GiriÅŸ baÅŸarÄ±sÄ±z';
                    msgEl.className = 'msg err';
                    btn.disabled = false;
                }
            } catch (err) {
                msgEl.textContent = 'Sunucuya baÄŸlanÄ±lamadÄ±';
                msgEl.className = 'msg err';
                btn.disabled = false;
            }
        }

        function showReset() {
            document.getElementById('resetSection').style.display = 'block';
        }

        async function sendOTP() {
            const telefon = document.getElementById('resetPhone').value.trim();
            if (!telefon) { alert('Telefon numarasÄ± girin'); return; }

            const res = await fetch('/api/auth/reset-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ telefon })
            });
            const data = await res.json();

            msgEl.textContent = data.message;
            msgEl.className = 'msg ok';
            document.getElementById('otpSection').style.display = 'block';
        }

        async function confirmReset() {
            const telefon = document.getElementById('resetPhone').value.trim();
            const otp = document.getElementById('otpCode').value.trim();
            const yeni_sifre = document.getElementById('newPassword').value;

            if (!otp || !yeni_sifre) { alert('Kod ve yeni ÅŸifre gerekli'); return; }

            const res = await fetch('/api/auth/reset-password/confirm', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ telefon, otp, yeni_sifre })
            });
            const data = await res.json();

            if (data.success) {
                msgEl.textContent = 'Åžifreniz gÃ¼ncellendi! GiriÅŸ yapabilirsiniz.';
                msgEl.className = 'msg ok';
                document.getElementById('resetSection').style.display = 'none';
            } else {
                msgEl.textContent = data.message;
                msgEl.className = 'msg err';
            }
        }

        // Zaten giriÅŸ yapmÄ±ÅŸsa yÃ¶nlendir
        const existingToken = localStorage.getItem('auth_token');
        if (existingToken) {
            try {
                const p = JSON.parse(atob(existingToken.split('.')[1]));
                if (p.exp * 1000 > Date.now()) {
                    // Sadece dashboard varsa yÃ¶nlendir, yoksa burada kal
                    const target = p.is_super_admin ? '/pages/admin/index.html' : '/pages/dashboard/index.html';
                    fetch(target, { method: 'HEAD' }).then(r => {
                        if (r.ok) window.location.href = target;
                    }).catch(() => {});
                }
            } catch {}
        }
    </script>
</body>
</html>
